# Docs

## Commands

### System

- `nixos-rebuild switch`: rebuild the system using the `/etc/nixos/configuration.nix`
- `nixos-rebuild switch .`: rebuild the system using the configuration at CWD.
- `nixos-rebuild switch --flake .#dan`: to rebuild using the flake at CWD using the "dan" argument
- `home-manager switch --flake .#dan`: to switch to the home-manager configuration at CWD using the "dan" arg

### Nix

`nix-shell -p <package1> <package2> ...`: create a temporary shell including the specified packages.

## Glossary

- **flake**: a self-contained unit of nix configuration, which can be anything from a single package to a whole system configuration (e.g. [nixos_flake](./nixos_flake)). Flakes are composable, meaning that one flake can include other flakes.
- **derivation**: a description of a `nix build` task.
- **nix store**: the `/nix/store` contains all built and downloaded packages.

## NixOS Vs Nix

`Nix` is a package manager that can be used on any linux distro. NixOS is a linux distro built around and tightly coupled with `nix`.

`home-manager` can be used on any linux distro alongside `nix`, and together they bring most of the benefits of NixOS without much of the learning curve.

## Resources

- [mynixos.com](https://mynixos.com): user friendly nixos (and home-manager) package/program/option docs.
- [librephoenix nixos blog series](https://librephoenix.com/2023-10-21-intro-flake-config-setup-for-new-nixos-users.html): excellent blog series covering everything I do here and more.
- [bob vanderlinden's nix workshop slides](https://bobvanderlinden.github.io/nix-workshop/#/): slides to give an overview of the practical use cases of nix.
- [NixOS vs Ubuntu Cheatsheet](https://nixos.wiki/wiki/Ubuntu_vs._NixOS): illustrates common operations in Ubuntu and NixOS.
- [No Boilerplate's Everything, Everywhere, All At Once](https://www.youtube.com/watch?v=CwfKlX3rA6E): illustrates some of Nix's best selling points. Inspired me to check out NixOS.
- [sops-nix video by vimjoyer](https://github.com/vimjoyer/sops-nix-video): secrets management with sops and nix.

## Troubleshooting

### Nix Flakes

- If `nix flake` commands are not available, try this:

  ```sh
  mkdir ~/.config/nix
  echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
  ```

## Secrets

I use `sops` (via `nix-sops`) to manage my secrets, using a key generated by `age`.

### Restoring Secrets on a New Machine

1. Create `~/.config/sops/age/keys.txt` containing the secret key (bitwarden: "SOPS age key")

> [!WARNING]
> **Do not** `echo ".." > ~/.config/sops/age/keys.txt` because that will add it to history

2. You're done! Decrypt secrets using `sops secrets/secrets.yaml`

### Setup From Scratch

_**NOTE**: If starting from scratch (i.e. without an existing key), all existing secrets will be discarded and new ones must be created_

1. If not already done, install `age` and `sops`:

   ```sh
   nix-shell -p age sops
   ```

2. Generate a new key using `age`:

```sh
nix shell nixpkgs#age -c age-keygen -o ~/.config/sops/age/keys.txt
```

3. Get the matching public key for `~/.config/sops/age/keys.txt` and use it as the public key in [.sops.yaml](./.sops.yaml)
